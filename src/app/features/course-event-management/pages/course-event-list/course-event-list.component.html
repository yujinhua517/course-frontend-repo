<div class="course-event-list-container">
    <!-- 頁面標題與操作區 -->
    <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title fw-bold mb-0">
            <i class="bi bi-calendar-event me-2 text-primary"></i>
            課程活動管理
        </h2>
        <div class="header-actions d-flex gap-2">
            @if (selectedCourseEvents().length > 0 && permissions().delete) {
            <button type="button" class="btn btn-outline-danger" (click)="onBulkDelete()" aria-label="批量刪除">
                <i class="bi bi-trash me-1"></i>
                刪除選中項目 ({{ selectedCourseEvents().length }})
            </button>
            }
            @if (permissions().create) {
            <button type="button" class="btn btn-outline-secondary" (click)="exportData()" aria-label="匯出資料">
                <i class="bi bi-download me-1"></i>
                匯出
            </button>
            <button type="button" class="btn btn-primary" (click)="onAdd()" aria-label="新增課程活動">
                <i class="bi bi-plus-circle me-1"></i>
                新增課程活動
            </button>
            }
        </div>
    </div>

    <!-- 搜尋與篩選區 -->
    <app-search-filter [config]="searchFilterConfig()" [searchKeyword]="searchKeyword()" [pageSize]="pageSize()"
        [totalCount]="total()" [loading]="loading()" [filterValues]="currentFilterValues()"
        (searchChanged)="onSearch($event)" (filterChanged)="onFilter($event)"
        (pageSizeChanged)="onPageSizeChange($event)" (searchCleared)="onClearFilters()">
    </app-search-filter>

    <!-- 載入狀態 -->
    @if (loading()) {
    <app-loading-state [config]="loadingConfig()"></app-loading-state>
    }

    <!-- 錯誤訊息 -->
    @if (!loading() && error()) {
    <app-error-message [config]="errorConfig()" (errorDismissed)="onRetry()"></app-error-message>
    }

    <!-- 資料表格 -->
    @if (!loading() && !error() && courseEvents().length > 0) {
    <div class="table-container card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <app-table-header [config]="tableHeaderConfig()" (sortChanged)="onSort($event)"
                        (selectAllChanged)="onSelectAll($event)">
                    </app-table-header>
                </thead>
                <tbody>
                    <app-table-body [config]="tableBodyConfig()" [selectedItems]="selectedCourseEvents()"
                        (itemSelected)="onItemSelect($event.item, $event.selected)">
                    </app-table-body>
                </tbody>
            </table>
        </div>
    </div>
    }

    <!-- 模板定義 -->
    <ng-template #idTemplate let-courseEvent>
        <span [innerHTML]="courseEvent.courseEventId | highlight:searchKeyword()"></span>
    </ng-template>

    <ng-template #yearTemplate let-courseEvent>
        <span [innerHTML]="courseEvent.year | highlight:searchKeyword()"></span>
    </ng-template>

    <ng-template #semesterTemplate let-courseEvent>
        <span [innerHTML]="courseEvent.semester | highlight:searchKeyword()"></span>
    </ng-template>

    <ng-template #activityTitleTemplate let-courseEvent>
        <span [innerHTML]="courseEvent.activityTitle | highlight:searchKeyword()"></span>
    </ng-template>

    <ng-template #statusTemplate let-courseEvent>
        <app-status-badge [config]="getStatusConfig(courseEvent)" (statusToggled)="onToggleStatus(courseEvent)"
            [ariaLabel]="'切換 ' + courseEvent.activityTitle + ' 的狀態'">
        </app-status-badge>
    </ng-template>

    <ng-template #dateTemplate let-courseEvent let-column="column">
        @if (courseEvent[column.key]) {
        {{ courseEvent[column.key] | date:'yyyy/MM/dd' }}
        } @else {
        <span class="text-muted">-</span>
        }
    </ng-template>

    <ng-template #descriptionTemplate let-courseEvent>
        @if (courseEvent.description) {
        <span class="description-text" [title]="courseEvent.description"
            [innerHTML]="courseEvent.description | highlight:searchKeyword()"></span>
        } @else {
        <span class="text-muted">無描述</span>
        }
    </ng-template>

    <ng-template #actionTemplate let-courseEvent>
        <app-action-button-group [config]="getActionConfig(courseEvent)" (viewClicked)="onActionView(courseEvent)"
            (editClicked)="onActionEdit(courseEvent)" (deleteClicked)="onActionDelete(courseEvent)">
        </app-action-button-group>
    </ng-template>

    <!-- 空狀態 -->
    @if (!loading() && !error() && courseEvents().length === 0) {
    <app-empty-state [config]="emptyConfig()" (createClicked)="onAdd()"></app-empty-state>
    }

    <!-- 分頁控制 -->
    @if (!loading() && !error() && courseEvents().length > 0 && totalPages() > 1) {
    <app-pagination [config]="paginationConfig()" (pageChanged)="onPageChange($event)">
    </app-pagination>
    }
</div>

<!-- 表單模態視窗 -->
@if (showForm()) {
<app-course-event-form [mode]="formMode()" [entity]="selectedCourseEvent()" (saved)="onFormSaved($event)"
    (cancelled)="onFormCancelled()">
</app-course-event-form>
}

<!-- 檢視模態視窗 -->
@if (showView()) {
<app-course-event-view [courseEvent]="selectedCourseEvent()!" (closed)="onViewClosed()">
</app-course-event-view>
}

<!-- 批量刪除確認模態框 -->
<app-confirmation-modal [config]="bulkDeleteConfirmConfig()" [show]="showBulkDeleteConfirm()"
    [loading]="bulkDeleteLoading()" (confirmed)="onBulkDeleteConfirmed()" (cancelled)="onBulkDeleteCancelled()">
</app-confirmation-modal>

<!-- 個別刪除確認模態框 -->
<app-confirmation-modal [config]="deleteConfirmConfig()" [show]="showDeleteConfirm()" [loading]="actionLoading()"
    (confirmed)="onDeleteConfirmed()" (cancelled)="onDeleteCancelled()">
</app-confirmation-modal>

<!-- 狀態切換確認模態框 -->
<app-confirmation-modal [config]="statusConfirmConfig()" [show]="showStatusConfirm()" [loading]="actionLoading()"
    (confirmed)="onStatusConfirmed()" (cancelled)="onStatusCancelled()">
</app-confirmation-modal>